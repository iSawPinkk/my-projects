import requests
import csv
from bs4 import BeautifulSoup
ctgy_index = {
    "Travel": "https://books.toscrape.com/catalogue/category/books/travel_2/index.html",
    "Mystery": "https://books.toscrape.com/catalogue/category/books/mystery_3/index.html",
    "Historical Fiction": "https://books.toscrape.com/catalogue/category/books/historical-fiction_4/index.html",
    "Sequential Art": "https://books.toscrape.com/catalogue/category/books/sequential-art_5/index.html",
    "Classics": "https://books.toscrape.com/catalogue/category/books/classics_6/index.html",
    "Philosophy": "https://books.toscrape.com/catalogue/category/books/philosophy_7/index.html",
    "Romance": "https://books.toscrape.com/catalogue/category/books/romance_8/index.html",
    "Womens Fiction": "https://books.toscrape.com/catalogue/category/books/womens-fiction_9/index.html",
    "Fiction": "https://books.toscrape.com/catalogue/category/books/fiction_10/index.html",
    "Childrens": "https://books.toscrape.com/catalogue/category/books/childrens_11/index.html",
    "Religion": "https://books.toscrape.com/catalogue/category/books/religion_12/index.html",
    "Nonfiction": "https://books.toscrape.com/catalogue/category/books/nonfiction_13/index.html",
    "Music": "https://books.toscrape.com/catalogue/category/books/music_14/index.html",
    "Default": "https://books.toscrape.com/catalogue/category/books/default_15/index.html",
    "Science Fiction": "https://books.toscrape.com/catalogue/category/books/science-fiction_16/index.html",
    "Sports and Games": "https://books.toscrape.com/catalogue/category/books/sports-and-games_17/index.html",
    "Add a comment": "https://books.toscrape.com/catalogue/category/books/add-a-comment_18/index.html",
    "Fantasy": "https://books.toscrape.com/catalogue/category/books/fantasy_19/index.html",
    "New Adult": "https://books.toscrape.com/catalogue/category/books/new-adult_20/index.html",
    "Young Adult": "https://books.toscrape.com/catalogue/category/books/young-adult_21/index.html",
    "Science": "https://books.toscrape.com/catalogue/category/books/science_22/index.html",
    "Poetry": "https://books.toscrape.com/catalogue/category/books/poetry_23/index.html",
    "Paranormal": "https://books.toscrape.com/catalogue/category/books/paranormal_24/index.html",
    "Art": "https://books.toscrape.com/catalogue/category/books/art_25/index.html",
    "Psychology": "https://books.toscrape.com/catalogue/category/books/psychology_26/index.html",
    "Autobiography": "https://books.toscrape.com/catalogue/category/books/autobiography_27/index.html",
    "Parenting": "https://books.toscrape.com/catalogue/category/books/parenting_28/index.html",
    "Adult Fiction": "https://books.toscrape.com/catalogue/category/books/adult-fiction_29/index.html",
    "Humor": "https://books.toscrape.com/catalogue/category/books/humor_30/index.html",
    "Horror": "https://books.toscrape.com/catalogue/category/books/horror_31/index.html",
    "History": "https://books.toscrape.com/catalogue/category/books/history_32/index.html",
    "Food and Drink": "https://books.toscrape.com/catalogue/category/books/food-and-drink_33/index.html",
    "Christian Fiction": "https://books.toscrape.com/catalogue/category/books/christian-fiction_34/index.html",
    "Business": "https://books.toscrape.com/catalogue/category/books/business_35/index.html",
    "Biography": "https://books.toscrape.com/catalogue/category/books/biography_36/index.html",
    "Thriller": "https://books.toscrape.com/catalogue/category/books/thriller_37/index.html",
    "Contemporary": "https://books.toscrape.com/catalogue/category/books/contemporary_38/index.html",
    "Spirituality": "https://books.toscrape.com/catalogue/category/books/spirituality_39/index.html",
    "Academic": "https://books.toscrape.com/catalogue/category/books/academic_40/index.html",
    "Self Help": "https://books.toscrape.com/catalogue/category/books/self-help_41/index.html",
    "Historical": "https://books.toscrape.com/catalogue/category/books/historical_42/index.html",
    "Christian": "https://books.toscrape.com/catalogue/category/books/christian_43/index.html",
    "Suspense": "https://books.toscrape.com/catalogue/category/books/suspense_44/index.html",
    "Short Stories": "https://books.toscrape.com/catalogue/category/books/short-stories_45/index.html",
    "Novels": "https://books.toscrape.com/catalogue/category/books/novels_46/index.html",
    "Health": "https://books.toscrape.com/catalogue/category/books/health_47/index.html",
    "Politics": "https://books.toscrape.com/catalogue/category/books/politics_48/index.html",
    "Cultural": "https://books.toscrape.com/catalogue/category/books/cultural_49/index.html",
    "Erotica": "https://books.toscrape.com/catalogue/category/books/erotica_50/index.html",
    "Crime": "https://books.toscrape.com/catalogue/category/books/crime_51/index.html"
}
inp=input("""Please enter the category you want:

Travel, Mystery, Historical Fiction, Sequential Art, Classics
Philosophy, Romance, Womens Fiction, Fiction, Childrens
Religion, Nonfiction, Music, Default, Science Fiction
Sports and Games, Add a comment, Fantasy, New Adult, Young Adult
science, Poetry, Paranormal, Art, Psychology
Autobiography, Parenting, Adult Fiction, Humor, Horror
History, Food and Drink, Christian Fiction, Business, Biography
Thriller, Contemporary, Spirituality, Academic, Self Help
Historical, Christian, Suspense, Short Stories
         
--->""")

ctgy_url=ctgy_index.get(inp)#target
if not ctgy_url:
    print("category doesnt exist")
    exit()
books=[] #refresh

print("="*40)
print("code running, please wait...")
while ctgy_url: #get items
    res=requests.get(ctgy_url)
    if res.status_code !=200:
        print(f"url error: {ctgy_url} --> {res.status_code}")
        break
    soup=BeautifulSoup(res.text,"html.parser") #decode html
    book_items=soup.find_all("article",class_="product_pod") #find all books

    for book in book_items:
        title=book.h3.a['title'].strip() #get book title

        price=book.find("p",class_="price_color").text.strip() #get book price(euro to ntd)
        price= price.replace("£",'').replace('Â','').strip()
        price=float(price)*36

        rating=book.find("p",class_="star-rating")["class"] #html中tag物件的class屬性 ---> ["rating_class","four"]
        rating_dict = {"One":1,"Two":2,"Three":3,"Four":4,"Five":5}
        rating=rating_dict.get(rating[1],0)

        book_data={"book_title":title,
                   "price(NTD)":price,
                   "rating":rating,
                   }
        books.append(book_data)

    next_page=soup.find("li",class_="next")
    if next_page:
        next_url=next_page.a["href"] #存取 <a>中href標籤的方法
        base=ctgy_url.rsplit("/",1)[0]+"/" #return "https:/"
        ctgy_url= base + next_url #組合成新url
    else:
        ctgy_url=None

#創建一個csv檔已儲存結果
csv_file= rf"C:\Users\Ryan Lin\Desktop\{inp}_books.csv"
with open(csv_file,"w",newline="",encoding="utf-8") as f:
    writer= csv.DictWriter(f, fieldnames=["book_title","price(NTD)","rating"])
    writer. writeheader()
    writer. writerows(books)

print("="*40)
print("your file is on desktop!")






